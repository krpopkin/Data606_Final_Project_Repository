---
title: "DATA 606 Data Project"
author: "Ken Popkin"
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(reshape2)
library(ggpubr)

require(scales)
```


```{r echo=FALSE}
# load data
data <- read.csv('https://raw.githubusercontent.com/krpopkin/Data606_Final_Project_Repository/master/01Data/%20master.csv')

cases = dim(data)[1]
features = dim(data)[2]
cat('Data for this project is', cases, 'cases and', features, 'features')
```

```{r data}
head(data,1)
```

### Part 1 - Introduction
<I> Can education and wages be used as predictors for home values? </I>    
There are many factors theorized to influence a home’s value and for this project we’ll attempt to answer if two popular topics, education and wages, can be used as predictors for a third popular topic, home values.

Knowing key factors to monitor regarding your home’s value can prove beneficial in multiple areas of modern life.  Areas such as, assessing your long term financial outlook, deciding whether to move or not; and perhaps most important, enabling these and similar decisions to not be based solely on emotion.  

### Part 2 - Data
The master data file loaded above is a combination of three files ([education](https://nces.ed.gov/ccd/f33agency.asp), [wages](https://www.bls.gov/cew/downloadable-data-files.htm), and [home values](https://www.zillow.com/research/data/)) that were merged using state/county as the key.  For details about the cleaning, filtering, and merging of this data to create the master file refer to the [project proposal](https://www.rpubs.com/krpopkin/591317).

### Part 3 - Exploratory data analysis
<B> Correlation Heat Maps </B>  
We'll start off with a heat map to highlight the correlations between Education, Wages, and Home Values.  First we'll look at the four education categories of high school dropout, high school diploma, some college, and four year degree.  There should be high correlation between each of these so we'll select the one with highest correlation to home values to move forward with.

```{r education-heatmap}
#Select the data for the education heat map
ehm <- data %>%
  select(hs_dropout = dropout_percent, hs_diploma = hs_diploma_percent, some_college = some_college_percent,  college_degree = four_year_degree_percent, avg_home_value)

#Calculate the correlation values
cormat <- round(cor(ehm),2)

melted_cormat <- melt(cormat)

#Create the Heatmap
library(ggplot2)
ggheatmap <- ggplot(data = melted_cormat, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Pearson\nCorrelation") +
  theme_minimal()+ 
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1))+
 coord_fixed()

reorder_cormat <- function(cormat){
# Use correlation between variables as distance
dd <- as.dist((1-cormat)/2)
hc <- hclust(dd)
cormat <-cormat[hc$order, hc$order]
}

ggheatmap + 
geom_text(aes(Var2, Var1, label = value), color = "black", size = 4)
```
The education heatmap correlation of 69% correlation with a college degree and home values was somewhat expected.  The -61% corelation for a high school diploma (so no higher education) with home values was initially surprising, but does make sense.

Next we'll generate a heatmap using wages and home values.
```{r heatmap}
#Select the data for the heat map
chm <- data %>%
  select(avg_annual_pay, avg_home_value)

#Calculate the correlation values
cormat <- round(cor(chm),2)

melted_cormat <- melt(cormat)

#Create the Heatmap
library(ggplot2)
ggheatmap <- ggplot(data = melted_cormat, aes(Var2, Var1, fill = value))+
 geom_tile(color = "white")+
 scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Pearson\nCorrelation") +
  theme_minimal()+ 
 theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1))+
 coord_fixed()

reorder_cormat <- function(cormat){
# Use correlation between variables as distance
dd <- as.dist((1-cormat)/2)
hc <- hclust(dd)
cormat <-cormat[hc$order, hc$order]
}

ggheatmap + 
geom_text(aes(Var2, Var1, label = value), color = "black", size = 4)
```

The 52% correlation is strong, but not as strong as expected.  What surprising for me is that average pay is showing a lower correlation than education in the previous heatmap.

<B> Home Values and Wages Colored by Census Region </B>   
There are 2,745 counties across 50 states, but only 4 census regions. We'll use regions to create several visual representations of the relationships between education, wages, and home values. 
```{r home-values-and-wages}
hvw <- select(data, region, avg_annual_pay, avg_home_value)

#Scatter chart
hvw_scatter <- ggplot(hvw, aes(avg_annual_pay, avg_home_value, colour = region)) + 
  geom_point(alpha=0.5) +
  scale_x_continuous(labels = comma) + 
  scale_y_continuous(labels = comma)

#Violin chart
hvw_violin <- ggplot(hvw, aes(avg_annual_pay, avg_home_value, colour = region)) + 
  scale_x_continuous(labels = comma) + 
  scale_y_continuous(labels = comma) +
  geom_violin()

#Show scatter and violin plots
ggarrange(hvw_scatter, hvw_violin,
                    labels = c("Home Values", "Wages"),
                    ncol = 2, nrow = 1,
                    common.legend = TRUE, legend = "bottom")
```

<B> Home Values and Four Year College Degrees Colored by Census Region </B>  
```{r}
hvc <- select(data, region, four_year_degree_percent, avg_home_value)

#Scatter plot
hvc_scatter <- ggplot(hvc, aes(four_year_degree_percent, avg_home_value, colour = region)) + 
  geom_point(alpha=0.5) +
  scale_x_continuous(labels = comma) + 
  scale_y_continuous(labels = comma)

#Violin plot
hvc_violin <- ggplot(hvc, aes(four_year_degree_percent, avg_home_value, colour = region)) + 
  geom_violin() +
  scale_x_continuous(labels = comma) + 
  scale_y_continuous(labels = comma)

#Show scatter and violin plots
ggarrange(hvc_scatter, hvc_violin,
                    labels = c("Home Values", "Degree"),
                    ncol = 2, nrow = 1,
                    common.legend = TRUE, legend = "bottom")
```

<B> Side by Side Comparison by Region of Education, Wages, and Home Values </B>  
We'll conclude the visuals with this side by side comparison...
```{r}
dfviolin <- select(data, region, four_year_degree_percent, avg_annual_pay, avg_home_value)

dfviolin$region_num = as.factor(ifelse(dfviolin$region == 'Northeast',1,ifelse(dfviolin$region == 'South',2,ifelse(dfviolin$region == 'Midwest',3,ifelse(dfviolin$region == 'West',4,5)))))

#Violin of education
violin_education <- ggplot(dfviolin, aes(region_num, four_year_degree_percent, colour = region)) + 
  geom_violin(trim = FALSE)

#Violin of wages
violin_wages <- ggplot(dfviolin, aes(region_num, avg_annual_pay, colour = region)) + 
  geom_violin(trim = FALSE) + 
  scale_y_continuous(labels = comma)

#Violin of home values
violin_home_value <- ggplot(dfviolin, aes(region_num, avg_home_value, colour = region)) + 
  geom_violin(trim = FALSE)
```

```{r}
figure <- ggarrange(violin_education, violin_wages, violin_home_value,
                    labels = c("Education", "Wages", "Home Values"),
                    ncol = 3, nrow = 1,
                    common.legend = TRUE, legend = "bottom")

figure
```

### Part 4 - Inference


### Part 5 - Conclusion


### References
[This article](http://www.sthda.com/english/wiki/ggplot2-quick-correlation-matrix-heatmap-r-software-and-data-visualization) was a huge help in generating the map.
